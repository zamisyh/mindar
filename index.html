<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@6.1.1/dist/aframe-extras.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-gesture-detector@1.0.0/dist/aframe-gesture-detector.min.js"></script>
  </head>
  <body>
    <a-scene
      mindar-image="imageTargetSrc: https://zamisyh.github.io/mindar/sakuraqr.mind"
      color-space="sRGB"
      renderer="colorManagement: true, physicallyCorrectLights"
      vr-mode-ui="enabled: false"
      device-orientation-permission-ui="enabled: false"
    >
      <a-assets>
        <a-asset-item id="avatarModel" src="sybil.glb"></a-asset-item>
      </a-assets>

      <a-camera fov="50" position="0 150 180" look-controls="enabled: true"></a-camera>
      <a-entity id="mytarget" mindar-image-target="targetIndex: 0">
        <a-gltf-model
          src="#avatarModel"
          position="0 0 0"
          scale="0.5 0.5 0.5"
          rotation="0 0 0"
          gesture-handler
        ></a-gltf-model>
      </a-entity>
    </a-scene>

    <script>
      AFRAME.registerComponent("gesture-handler", {
        schema: {
          enabled: { default: true },
          rotationFactor: { default: 5 },
          scaleFactor: { default: 0.01 },
        },
        init: function () {
          this.handlePinch = this.handlePinch.bind(this);
          this.handleRotate = this.handleRotate.bind(this);
          this.handleClick = this.handleClick.bind(this);
          this.initialScale = this.el.object3D.scale.clone();
          this.scaleFactor = 1;
          this.rotationFactor = 0;
          this.setupListeners();
        },
        setupListeners: function () {
          const scene = this.el.sceneEl;
          scene.addEventListener("gesture-pinch", this.handlePinch);
          scene.addEventListener("gesture-rotate", this.handleRotate);
          scene.addEventListener("click", this.handleClick);
        },
        handlePinch: function (event) {
          this.scaleFactor += event.detail.spreadChange * this.data.scaleFactor;
          this.el.object3D.scale.set(
            this.initialScale.x * this.scaleFactor,
            this.initialScale.y * this.scaleFactor,
            this.initialScale.z * this.scaleFactor
          );
        },
        handleRotate: function (event) {
          this.rotationFactor += event.detail.angleChange * this.data.rotationFactor;
          this.el.object3D.rotation.y += this.rotationFactor;
        },
        handleClick: function () {
          console.log("Model clicked!");
        },
      });
    </script>
  </body>
</html>
